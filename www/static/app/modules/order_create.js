/*! xshowroom - v1.0.0 - 2016-01-15 */angular.module("xShowroom.order.create",["xShowroom.i18n","xShowroom.directives","mgcrea.ngStrap"]).controller("OrderCreateCtrl",["$scope","$modal","$window","$filter","Cart","Order","Collection","Buyer",function(a,b,c,d,e,f,g,h){a.removeProductFromCart=function(f){e.removeProduct({productionId:f.id}).success(function(e){if("object"!=typeof e||e.status)return void b({title:d("translate")("modal__title__ERROR"),content:d("translate")("modal__msg__error__SYSTEM_ERROR"),show:!0});var g=a.products.indexOf(f);a.products.splice(g,1),delete a.quantities[f.id],a.products.length||c.open("/buyer/cart","_self")})},a.getQuantity=function(b){var c=0;for(var d in a.quantities[b])for(var e in a.quantities[b][d])c+=parseInt(a.quantities[b][d][e]||0);return c},a.getAmount=function(b,c){return a.getQuantity(b)*c},a.getTotalQuantity=function(){var b=0;for(var c in a.quantities)b+=a.getQuantity(c);return b},a.getTotalAmount=function(){if(!a.products)return 0;for(var b=0,c=0,d=a.products.length;d>c;c++)b+=a.getQuantity(a.products[c].id)*a.products[c].wholePrice;return b},a.getRestAmount=function(){return a.minOrder-a.getTotalAmount()},a.validNumber=function(b,c,d){var e=a.quantities[b][c][d],f=/^(0|[1-9]{1}\d*)$/,g=f.test(e);e&&!g&&(a.quantities[b][c][d]=null)},a.checkout=function(){if(a.getRestAmount()>0)b({title:d("translate")("modal__title__ERROR"),content:d("translate")("modal__message__ERROR__ORDER_NOT_ENOUGH"),show:!0});else{for(var c=[],e=0,f=a.products.length;f>e;e++){var g=a.products[e].id;for(var i in a.quantities[g])for(var j in a.quantities[g][i])a.quantities[g][i][j]>0&&c.push({name:a.products[e].name,styleNumber:a.products[e].styleNum,sizeCode:j,color:i,buyNum:a.quantities[g][i][j],wholePrice:a.products[e].wholePrice})}if(a.orderItems=c,a.stores)return void(a.generateOrderStep+=1);h.getAuthedShopList({collectionId:a.collectionId}).success(function(c){return"object"!=typeof c||c.status?void b({title:d("translate")("modal__title__ERROR"),content:c.msg,show:!0}):(a.stores=c.data,void(a.generateOrderStep+=1))})}},a.setOptions=function(){return a.order.store?a.order.paymentType?void(a.generateOrderStep+=1):void b({title:d("translate")("modal__title__ERROR"),content:d("translate")("modal__msg__error__ORDER_NOT_SELECT_PAYMENT_METHOD"),show:!0}):void b({title:d("translate")("modal__title__ERROR"),content:d("translate")("modal__msg__error__ORDER_NOT_SELECT_SHIP_ADDRESS"),show:!0})},a.submitOrder=function(){for(var e={},g=0,h=a.products.length;h>g;g++){var i=a.products[g].id;for(var j in a.quantities[i])for(var k in a.quantities[i][j])a.quantities[i][j][k]>0&&(e[i]||(e[i]=[]),e[i].push({size_code:k,color:j,buy_num:a.quantities[i][j][k]}))}f.create({collectionId:a.collectionId,productionDetail:e,address:a.order.store.address,paymentType:a.order.paymentType,shopId:a.order.store.id}).success(function(a){return"object"!=typeof a||a.status?void b({title:d("translate")("modal__title__ERROR"),content:a.msg,show:!0}):void c.open("/order/list","_self")})};var i=function(){a.generateOrderStep=1,a.order={},e.findOne({collectionId:a.collectionId}).success(function(c){if("object"!=typeof c||c.status)return void b({title:d("translate")("modal__title__ERROR"),content:c.msg,show:!0});a.quantities={};for(var e=0,f=c.data.length;f>e;e++){var g=c.data[e].id;a.quantities[g]={};var h=[];for(var i in c.data[e].sizeCode)h.push(i);for(var j=0,k=c.data[e].color.length;k>j;j++){var l=c.data[e].color[j].name;a.quantities[g][l]={};for(var i in c.data[e].sizeCode)a.quantities[g][l][i]=null}c.data[e].size=h}a.products=c.data}),g.findById({id:a.collectionId}).success(function(c){return"object"!=typeof c||c.status?void b({title:d("translate")("modal__title__ERROR"),content:c.msg,show:!0}):void(a.collection=c.data)})};i()}]);