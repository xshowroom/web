/*! xshowroom - v1.0.0 - 2016-01-15 */angular.module("xShowroom.collection.index",["xShowroom.i18n","xShowroom.directives","xShowroom.services","mgcrea.ngStrap","ngTextcomplete","ngSanitize"]).controller("CollectionIndexCtrl",["$scope","$modal","$filter","$q","$location","Collection",function(a,b,c,d,e,f){a.checkInfo={validation:{name:!1,category:!1,mode:!1,season:!1,order:!1,currency:!1,deadline:!1,delivery:!1,description:!1,image:!1},reg:{order:/^\d+$/,deadline:/\d{4}-\d{2}-\d{2}/,delivery:/\d{4}-\d{2}-\d{2}/},duplication:["name"]},a.updateCollection=function(){a.errorMsgs=[];var e=[];for(var g in a.checkInfo.validation){var h=a.collection[g];"deadline"!=g&&"delivery"!=g||h?h&&""!=h?!a.checkInfo.reg[g]||a.checkInfo.reg[g].test(h)?(a.checkInfo.duplication.indexOf(g)>=0&&e.push(f.duplicationCheck({key:g,param:h,collectionId:a.collectionId})),a.checkInfo.validation[g]=!1):(a.errorMsgs.push([g,"PATTERN_ERROR"]),a.checkInfo.validation[g]=!0):(a.errorMsgs.push([g,"EMPTY_ERROR"]),a.checkInfo.validation[g]=!0):(a.errorMsgs.push([g,"DATE_ERROR"]),a.checkInfo.validation[g]=!0)}d.all(e).then(function(){for(var d=0;d<arguments[0].length;d++){var e=arguments[0][d],g=e.config.data.key;e.data.status?(a.checkInfo.validation[g]=!0,a.errorMsgs.push([g,"DUPLICATION_ERROR"])):a.checkInfo.validation[g]=!1}a.errorMsgs.length||f.modify(a.collection).success(function(a){"object"!=typeof a||a.status?b({title:c("translate")("modal__title__ERROR"),content:a.msg,show:!0}):window.location.reload()})})},a.deleteCollection=function(){f.destroy({id:a.collectionId}).success(function(a){"object"!=typeof a||a.status?b({title:c("translate")("modal__title__ERROR"),content:a.msg,show:!0}):window.open("/brand/collection","_self")})},a.enableCollection=function(){f.enable({id:a.collectionId}).success(function(a){"object"!=typeof a||a.status?b({title:c("translate")("modal__title__ERROR"),content:a.msg,show:!0}):window.location.reload()})},a.closeCollection=function(){f.close({id:a.collectionId}).success(function(a){"object"!=typeof a||a.status?b({title:c("translate")("modal__title__ERROR"),content:a.msg,show:!0}):window.location.reload()})},a.setDatesByMode=function(b){if("dropdown__COLLECTION_MODE__PERMANENT"==b){var d=(new Date).getFullYear(),e=new Date;e.setYear(d+100),a.collection.delivery=c("date")(e,"yyyy-MM-dd"),a.collection.deadline=c("date")(e,"yyyy-MM-dd")}else a.collection.delivery=null,a.collection.deadline=null};var g=function(){f.findById({id:a.collectionId}).success(function(d){d.status?b({title:c("translate")("modal__title__ERROR"),content:d.msg,show:!0}):a.collection={id:d.data.id,name:d.data.name,category:d.data.category,mode:d.data.mode,season:d.data.season,order:d.data.mini_order,currency:d.data.currency,deadline:d.data.deadline.split(/\s/)[0],delivery:d.data.delivery_date,description:d.data.description,image:d.data.cover_image}})},h=function(){f.getProductList({collectionId:a.collectionId,timestamp:(new Date).getTime()}).success(function(d){if("object"!=typeof d||d.status)return void b({title:c("translate")("modal__title__ERROR"),content:d.msg,show:!0});a.products=d.data,a.categoryCounter={};for(var e=0,f=a.products.length;f>e;e++){var g=a.products[e].category;a.categoryCounter[g]?a.categoryCounter[g]+=1:a.categoryCounter[g]=1}})},i=function(){a.hasAuth&&g(),a.filters={category:e.search().category||"",limit:8},h()};i()}]);